{% include "head.html" %}

<section class="hero is-info">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
        Active Polls
      </h1>

      <h2 class="subtitle">
        These are the active polls.
      </h2>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div id="poll_list_container"></div>
  </div>
</section>

<template id="mob__card">
  <div class="box">
    <div class="media-content">
      <div class="content"></div>
    </div>
  </div>
</template>

<script>
  {% include "./js/element.js" %}
</script>

<script>
  window.onload = function() {
    var mobCardTemplate = document.querySelector("#mob__card");

    var pollListContainer = document.querySelector("#poll_list_container");

    function fetchActivePolls() {
      return fetch("/api/polls", { method: "GET" })
        .then(p => {
          if (p.ok) {
            return p.json();
          }

          return Promise.reject(p);
        })
        .then(p => {
          pollListContainer.innerHTML = "";

          p.forEach(poll => {
            var clone = document.importNode(mobCardTemplate.content, true);

            var header = new Element("strong", {
              innerHTML: poll.question,
              style: {
                marginBottom: "20px",
                fontSize: "1.4rem"
              }
            });

            var content = clone.querySelector(".content");

            header.renderTo(content);

            const totalVoteCount = poll.options.reduce(
              (accu, current) => accu + current.totalVotes,
              0
            );

            poll.options.forEach(option => {
              var wrapper = new Element(
                "div",
                {
                  style: { marginTop: "10px" }
                },
                [
                  new Element("input", {
                    type: "radio",
                    id: option.value + poll.id.toString(),
                    name: poll.id.toString(),
                    style: {
                      marginRight: "5px",
                      cursor: "pointer"
                    }
                  }),
                  new Element("label", {
                    innerHTML: option.value,
                    for: option.value + poll.id.toString(),
                    style: {
                      cursor: "pointer"
                    }
                  }),
                  new Element("progress", {
                    class: "progress",
                    value: option.totalVotes,
                    max: totalVoteCount || 1,
                    style: {
                      display: "inline-block",
                      width: "50%",
                      marginLeft: "20px"
                    }
                  })
                ]
              );

              wrapper.renderTo(content);
            });

            pollListContainer.append(clone);
          });
        });
    }

    fetchActivePolls();
  };
</script>

{% include "footer.html" %}
